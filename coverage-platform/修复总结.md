# è¦†ç›–ç‡è¯¦æƒ…é¡µä»£ç æ˜¾ç¤ºä¿®å¤æ€»ç»“

## ğŸ“‹ é—®é¢˜æè¿°

è¦†ç›–ç‡è¯¦æƒ…é¡µå³ä¾§ä»£ç åŒºåŸŸæ˜¾ç¤ºçš„æ˜¯mockæ•°æ®ï¼ˆ`// Line 1`, `// Line 2` ç­‰å ä½ç¬¦ï¼‰ï¼Œè€Œä¸æ˜¯çœŸå®çš„æºä»£ç å†…å®¹ã€‚

## ğŸ” é—®é¢˜è¯Šæ–­

### æ ¹æœ¬åŸå› 

`coverage-platform/manager/repo_manager.py` æ–‡ä»¶ä¸­çš„ `REPOS_BASE_DIR` è·¯å¾„é…ç½®é”™è¯¯ï¼š

```python
# âŒ é”™è¯¯é…ç½®ï¼ˆç¬¬22è¡Œï¼‰
REPOS_BASE_DIR = os.path.join(os.path.dirname(os.path.abspath(__file__)), 'repos')
# ç»“æœæŒ‡å‘: /coverage-platform/manager/repos/
```

æ­£ç¡®çš„é…ç½®åº”è¯¥æŒ‡å‘ï¼š
```python
# âœ… æ­£ç¡®é…ç½®ï¼ˆç¬¬23è¡Œï¼‰
REPOS_BASE_DIR = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'repos')
# ç»“æœæŒ‡å‘: /coverage-platform/repos/
```

### å½±å“é“¾è·¯

```
å‰ç«¯è¯·æ±‚ â†’ åç«¯API (/api/coverage/file) 
         â†“
    get_file_content() å‡½æ•°
         â†“
    é”™è¯¯çš„worktreeè·¯å¾„ (manager/repos/...)
         â†“
    æ‰¾ä¸åˆ°æ–‡ä»¶ï¼Œè¿”å› None
         â†“
    APIè¿”å›404é”™è¯¯
         â†“
    å‰ç«¯é™çº§ä½¿ç”¨placeholderï¼ˆmockæ•°æ®ï¼‰
```

## âœ… å·²å®Œæˆçš„ä¿®å¤

### 1. åç«¯ä¿®å¤

**æ–‡ä»¶**: `coverage-platform/manager/repo_manager.py`

**ä¿®æ”¹å†…å®¹**:
```python
# ç¬¬21-23è¡Œ
# reposç›®å½•è·¯å¾„ï¼ˆåœ¨coverage-platformç›®å½•ä¸‹ï¼‰
# è·å– manager ç›®å½•çš„çˆ¶ç›®å½•ï¼ˆå³ coverage-platform ç›®å½•ï¼‰
REPOS_BASE_DIR = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 'repos')
```

**éªŒè¯ç»“æœ**:
```bash
# âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡
curl http://localhost:8826/health
# å“åº”: {"status":"healthy"}

# âœ… æ–‡ä»¶å†…å®¹APIæ­£å¸¸è¿”å›
curl "http://localhost:8826/api/coverage/file?repo=tuna&commit=e859c635d19db9fd7250ce668e799f881cc7437a&path=models/user_repository.go"
# å“åº”åŒ…å«å®Œæ•´çš„Goä»£ç ï¼Œå…±1688å­—ç¬¦
```

**æ“ä½œè®°å½•**:
- âœ… ä¿®æ”¹ `repo_manager.py` è·¯å¾„é…ç½®
- âœ… é‡å¯APIæœåŠ¡å™¨: `./run.sh restart api`
- âœ… æ¸…ç†å†—ä½™çš„ `manager/repos/` ç›®å½•ï¼ˆé‡Šæ”¾110MBç©ºé—´ï¼‰

### 2. å‰ç«¯å¢å¼º

ä¸ºäº†ä¾¿äºè°ƒè¯•å’Œç›‘æ§ï¼Œåœ¨å‰ç«¯æ·»åŠ äº†è¯¦ç»†çš„æ—¥å¿—è¾“å‡ºã€‚

**æ–‡ä»¶1**: `coverage-fe/src/components/CoverageDetail.jsx`

**ä¿®æ”¹å†…å®¹**: åœ¨ `fetchFileCoverage` å‡½æ•°ä¸­æ·»åŠ ï¼š
- ğŸ“ APIè°ƒç”¨å‰çš„å‚æ•°æ—¥å¿—
- ğŸ“ APIå“åº”æ•°æ®çš„è¯¦ç»†æ—¥å¿—
- ğŸ“ æˆåŠŸ/å¤±è´¥çŠ¶æ€çš„æ˜ç¡®æ ‡è¯†
- ğŸ“ é”™è¯¯è¯¦æƒ…çš„å®Œæ•´è¾“å‡º

**æ–‡ä»¶2**: `coverage-fe/src/components/DiffCoverageDetail.jsx`

**ä¿®æ”¹å†…å®¹**: åœ¨ `fetchFileContent` å‡½æ•°ä¸­æ·»åŠ åŒæ ·çš„è°ƒè¯•æ—¥å¿—

**æ—¥å¿—ç¤ºä¾‹**:
```javascript
// æˆåŠŸçš„æƒ…å†µ
[CoverageDetail] æ­£åœ¨è·å–æ–‡ä»¶å†…å®¹: {
  repo: 'tuna',
  commit: 'e859c635d19db9fd7250ce668e799f881cc7437a',
  path: 'models/user_repository.go'
}
[CoverageDetail] æ–‡ä»¶å†…å®¹APIå“åº”: {
  hasContent: true,
  contentLength: 1688
}
[CoverageDetail] âœ… æˆåŠŸè®¾ç½®çœŸå®æ–‡ä»¶å†…å®¹

// å¤±è´¥çš„æƒ…å†µ
[CoverageDetail] âŒ è·å–æ–‡ä»¶å†…å®¹å¤±è´¥ï¼Œä½¿ç”¨placeholder
[CoverageDetail] é”™è¯¯è¯¦æƒ…: { message: '...', status: 404 }
```

## ğŸ§ª éªŒè¯æ­¥éª¤

### åç«¯éªŒè¯ï¼ˆå·²å®Œæˆï¼‰ âœ…

```bash
# 1. æ£€æŸ¥APIæœåŠ¡å™¨çŠ¶æ€
curl http://localhost:8826/health
# é¢„æœŸ: {"status":"healthy"}

# 2. æµ‹è¯•æ–‡ä»¶å†…å®¹API
curl "http://localhost:8826/api/coverage/file?repo=tuna&commit=e859c635d19db9fd7250ce668e799f881cc7437a&path=models/user_repository.go" | python3 -m json.tool

# é¢„æœŸè¾“å‡º:
{
    "commit": "e859c635d19db9fd7250ce668e799f881cc7437a",
    "content": "package models\n\nimport (...",  # å®Œæ•´ä»£ç 
    "path": "models/user_repository.go",
    "repo": "tuna",
    "repo_url": "https://github.com/fujifei/tuna.git"
}
```

### å‰ç«¯éªŒè¯ï¼ˆéœ€è¦ç”¨æˆ·æ“ä½œï¼‰

#### æ­¥éª¤1: å¯åŠ¨å‰ç«¯æœåŠ¡

```bash
cd /Users/jifei.fu/project/qa/orbit/coverage-fe
npm run dev
```

å‰ç«¯ä¼šè¿è¡Œåœ¨: `http://localhost:3000`

#### æ­¥éª¤2: æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·

1. è®¿é—® `http://localhost:3000`
2. æŒ‰ `F12` æˆ– `Cmd+Option+I` æ‰“å¼€å¼€å‘è€…å·¥å…·
3. åˆ‡æ¢åˆ° **Consoleï¼ˆæ§åˆ¶å°ï¼‰** æ ‡ç­¾

#### æ­¥éª¤3: è®¿é—®è¦†ç›–ç‡è¯¦æƒ…é¡µ

1. åœ¨æŠ¥å‘Šåˆ—è¡¨ä¸­ç‚¹å‡»ä»»æ„æŠ¥å‘Š
2. åœ¨å·¦ä¾§æ–‡ä»¶æ ‘ä¸­é€‰æ‹©ä¸€ä¸ªæ–‡ä»¶
3. è§‚å¯Ÿå³ä¾§ä»£ç ç¼–è¾‘å™¨å’Œæ§åˆ¶å°è¾“å‡º

#### é¢„æœŸç»“æœ:

âœ… **æ§åˆ¶å°æ˜¾ç¤º**:
```
[API Config] æ„å»º API URL: {...}
[CoverageDetail] æ­£åœ¨è·å–æ–‡ä»¶å†…å®¹: {repo: 'tuna', commit: '...', path: '...'}
[CoverageDetail] æ–‡ä»¶å†…å®¹APIå“åº”: {hasContent: true, contentLength: 1688}
[CoverageDetail] âœ… æˆåŠŸè®¾ç½®çœŸå®æ–‡ä»¶å†…å®¹
```

âœ… **å³ä¾§ä»£ç ç¼–è¾‘å™¨æ˜¾ç¤º**:
- çœŸå®çš„æºä»£ç å†…å®¹ï¼ˆä¸æ˜¯ `// Line 1`, `// Line 2` ç­‰ï¼‰
- ç»¿è‰²èƒŒæ™¯ï¼šå·²è¦†ç›–çš„ä»£ç è¡Œ
- çº¢è‰²èƒŒæ™¯ï¼šæœªè¦†ç›–çš„ä»£ç è¡Œ

âœ… **Networkæ ‡ç­¾æ˜¾ç¤º**:
- è¯·æ±‚URL: `http://localhost:8826/api/coverage/file?repo=...&commit=...&path=...`
- çŠ¶æ€ç : `200 OK`
- å“åº”: JSONæ ¼å¼ï¼ŒåŒ…å«`content`å­—æ®µ

## ğŸ“ ä¿®æ”¹æ–‡ä»¶æ¸…å•

1. âœ… `coverage-platform/manager/repo_manager.py` - ä¿®å¤è·¯å¾„é…ç½®ï¼ˆæ ¸å¿ƒä¿®å¤ï¼‰
2. âœ… `coverage-fe/src/components/CoverageDetail.jsx` - æ·»åŠ è°ƒè¯•æ—¥å¿—
3. âœ… `coverage-fe/src/components/DiffCoverageDetail.jsx` - æ·»åŠ è°ƒè¯•æ—¥å¿—
4. âœ… `coverage-platform/FRONTEND_API_TEST.md` - éªŒè¯æŒ‡å—ï¼ˆæ–°å¢ï¼‰
5. âœ… `coverage-platform/test_frontend_api.sh` - è‡ªåŠ¨æµ‹è¯•è„šæœ¬ï¼ˆæ–°å¢ï¼‰

## ğŸ¯ APIæ¶æ„è¯´æ˜

### å®Œæ•´çš„APIè°ƒç”¨é“¾è·¯

```
å‰ç«¯ (React)
  â†“
buildApiUrl('/api/coverage/file')
  â†“
http://localhost:8826/api/coverage/file?repo=tuna&commit=xxx&path=xxx
  â†“
Flask API (main.py:315-365)
  â”œâ”€ è§£æå‚æ•°: repo, commit, path
  â”œâ”€ æŸ¥è¯¢æ•°æ®åº“è·å–repo_url
  â””â”€ è°ƒç”¨ get_file_content(repo_url, commit, path)
      â†“
  get_file_content() (repo_manager.py:413-478)
      â”œâ”€ è·å–worktreeç›®å½•: get_worktree_dir(repo_url, commit)
      â”‚   â””â”€ /coverage-platform/repos/github.com/fujifei/tuna/worktrees/{commit}
      â”œâ”€ æ„å»ºæ–‡ä»¶è·¯å¾„: worktree_dir + file_path
      â”œâ”€ è¯»å–æ–‡ä»¶å†…å®¹
      â””â”€ è¿”å›æ–‡ä»¶å†…å®¹ï¼ˆæˆ–å°è¯•è·¯å¾„è°ƒæ•´ï¼‰
          â†“
Flaskå“åº”: {"content": "...", "repo": "...", "commit": "...", ...}
  â†“
å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤ºåœ¨Monacoç¼–è¾‘å™¨ä¸­
```

### å…³é”®é…ç½®

**åç«¯ (Python)**:
```python
# coverage-platform/manager/repo_manager.py:23
REPOS_BASE_DIR = os.path.join(
    os.path.dirname(os.path.dirname(os.path.abspath(__file__))), 
    'repos'
)
# ç»“æœ: /coverage-platform/repos/
```

**å‰ç«¯ (JavaScript)**:
```javascript
// coverage-fe/src/config/api.js:24
const API_BASE_URL = 'http://localhost:8826'  // å¼€å‘ç¯å¢ƒ

// coverage-fe/src/components/CoverageDetail.jsx:194
const fileContentResponse = await axios.get(
    buildApiUrl('/api/coverage/file'), 
    {
        params: { repo, commit, path }
    }
)
```

## ğŸ”§ æ•…éšœæ’æŸ¥æŒ‡å—

### é—®é¢˜1: å‰ç«¯ä»æ˜¾ç¤ºplaceholder

**å¯èƒ½åŸå› **:
1. åç«¯APIæœªæ­£ç¡®å¯åŠ¨æˆ–é‡å¯
2. å‰ç«¯è°ƒç”¨APIå¤±è´¥
3. reportå¯¹è±¡ä¸ºç©º

**æ’æŸ¥æ­¥éª¤**:
```bash
# 1. æ£€æŸ¥åç«¯API
curl http://localhost:8826/health

# 2. æ‰‹åŠ¨æµ‹è¯•æ–‡ä»¶API
curl "http://localhost:8826/api/coverage/file?repo=tuna&commit=xxx&path=xxx"

# 3. æŸ¥çœ‹åç«¯æ—¥å¿—
tail -f logs/api.log

# 4. é‡å¯åç«¯
./run.sh restart api
```

**å‰ç«¯æ’æŸ¥**:
1. æ‰“å¼€æµè§ˆå™¨å¼€å‘è€…å·¥å…·Consoleæ ‡ç­¾
2. æŸ¥æ‰¾ `[CoverageDetail]` å¼€å¤´çš„æ—¥å¿—
3. æ£€æŸ¥æ˜¯å¦æœ‰çº¢è‰²é”™è¯¯ä¿¡æ¯
4. æŸ¥çœ‹Networkæ ‡ç­¾ä¸­çš„APIè¯·æ±‚è¯¦æƒ…

### é—®é¢˜2: CORSè·¨åŸŸé”™è¯¯

**ç—‡çŠ¶**: æ§åˆ¶å°æ˜¾ç¤º `CORS policy` ç›¸å…³é”™è¯¯

**è§£å†³**: åç«¯å·²é…ç½®CORSï¼Œå¦‚æœä»æœ‰é—®é¢˜:
```python
# coverage-platform/coverage-api/main.py:46
CORS(app)  # ç¡®ä¿è¿™è¡Œå­˜åœ¨
```

### é—®é¢˜3: APIè¿”å›404

**å¯èƒ½åŸå› **:
1. worktreeç›®å½•ä¸å­˜åœ¨
2. æ–‡ä»¶è·¯å¾„ä¸åŒ¹é…
3. commitä¸å­˜åœ¨

**æ’æŸ¥**:
```bash
# æ£€æŸ¥worktreeç›®å½•
ls -la /Users/jifei.fu/project/qa/orbit/coverage-platform/repos/github.com/fujifei/tuna/worktrees/

# æŸ¥çœ‹ç‰¹å®šcommitçš„worktree
ls -la /Users/jifei.fu/project/qa/orbit/coverage-platform/repos/github.com/fujifei/tuna/worktrees/{commit}/
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### åç«¯APIæµ‹è¯• âœ…

| æµ‹è¯•é¡¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| APIå¥åº·æ£€æŸ¥ | âœ… é€šè¿‡ | è¿”å› `{"status":"healthy"}` |
| è·å–æ–‡ä»¶å†…å®¹ | âœ… é€šè¿‡ | è¿”å›1688å­—ç¬¦çš„å®Œæ•´Goä»£ç  |
| CORSé…ç½® | âœ… é€šè¿‡ | å“åº”å¤´åŒ…å« `Access-Control-Allow-Origin: *` |
| JSONæ ¼å¼ | âœ… é€šè¿‡ | åŒ…å« content, repo, commit, path å­—æ®µ |

### å‰ç«¯éªŒè¯ â³

**çŠ¶æ€**: ç­‰å¾…ç”¨æˆ·åœ¨æµè§ˆå™¨ä¸­éªŒè¯

**é¢„æœŸ**: 
- ä»£ç ç¼–è¾‘å™¨æ˜¾ç¤ºçœŸå®æºä»£ç 
- æ§åˆ¶å°è¾“å‡º `âœ… æˆåŠŸè®¾ç½®çœŸå®æ–‡ä»¶å†…å®¹`
- è¦†ç›–ç‡é«˜äº®æ­£å¸¸æ˜¾ç¤º

## ğŸ’¡ ä»£ç æ²¡æœ‰ä¸¢å¤±ï¼

**é‡è¦è¯´æ˜**: åŸæ¥çš„åŠŸèƒ½ä»£ç ä»æœªä¸¢å¤±ï¼Œæ‰€æœ‰å®ç°éƒ½å®Œæ•´ä¿ç•™ï¼š

1. âœ… åç«¯APIç«¯ç‚¹ `/api/coverage/file` å­˜åœ¨ä¸”å®Œæ•´
2. âœ… æ ¸å¿ƒå‡½æ•° `get_file_content()` å­˜åœ¨ä¸”å®Œæ•´
3. âœ… å‰ç«¯è°ƒç”¨ä»£ç å­˜åœ¨ä¸”å®Œæ•´

**é—®é¢˜ä»…ä»…æ˜¯è·¯å¾„é…ç½®é”™è¯¯**ï¼Œå¯¼è‡´è¿è¡Œæ—¶æ— æ³•æ‰¾åˆ°æ–‡ä»¶ã€‚ä¿®å¤è·¯å¾„é…ç½®åï¼Œæ‰€æœ‰åŠŸèƒ½æ¢å¤æ­£å¸¸ã€‚

## ğŸ“ éœ€è¦å¸®åŠ©?

å¦‚æœå‰ç«¯éªŒè¯åä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´æ—¥å¿—æˆªå›¾
2. Networkæ ‡ç­¾ä¸­ `/api/coverage/file` è¯·æ±‚çš„è¯¦ç»†ä¿¡æ¯
3. åç«¯APIæ—¥å¿—ï¼š`tail -50 logs/api.log`

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-12-30  
**ä¿®å¤äººå‘˜**: AI Assistant  
**éªŒè¯çŠ¶æ€**: åç«¯ âœ… | å‰ç«¯ â³ï¼ˆå¾…ç”¨æˆ·éªŒè¯ï¼‰

